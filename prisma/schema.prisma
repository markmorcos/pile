// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  firebaseUid  String    @unique @map("firebase_uid")
  email        String    @unique
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  
  profile      Profile?

  @@map("users")
}

model Profile {
  id                  String   @id @default(cuid())
  userId              String   @unique @map("user_id")
  slug                String   @unique
  name                String?
  bio                 String?
  avatarUrl           String?  @map("avatar_url")
  publishGeneration   Int      @default(0) @map("publish_generation")
  publishedGeneration Int      @default(0) @map("published_generation")
  publishStatus       PublishStatus @default(IDLE) @map("publish_status")
  publishedUrl        String?  @map("published_url")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  links               Link[]
  jobs                Job[]

  @@map("profiles")
}

enum PublishStatus {
  IDLE
  RUNNING
}

model Link {
  id                   String   @id @default(cuid())
  profileId            String   @map("profile_id")
  url                  String
  draftTitle           String?  @map("draft_title")
  draftDescription     String?  @map("draft_description")
  draftImage           String?  @map("draft_image")
  publishedTitle       String?  @map("published_title")
  publishedDescription String?  @map("published_description")
  publishedImage       String?  @map("published_image")
  order                Int      @default(0)
  isActive             Boolean  @default(true) @map("is_active")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  
  profile              Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  jobs                 Job[]

  @@map("links")
  @@index([profileId, order])
}

model Job {
  id          String    @id @default(cuid())
  type        JobType
  entityType  EntityType @map("entity_type")
  entityId    String    @map("entity_id")
  profileId   String?   @map("profile_id")
  linkId      String?   @map("link_id")
  status      JobStatus @default(PENDING)
  error       String?
  retryCount  Int       @default(0) @map("retry_count")
  nextRetryAt DateTime? @map("next_retry_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  profile     Profile?  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  link        Link?     @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@map("jobs")
  @@index([type, status])
  @@index([entityType, entityId])
}

enum JobType {
  METADATA
  PUBLISH
}

enum EntityType {
  PROFILE
  LINK
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

